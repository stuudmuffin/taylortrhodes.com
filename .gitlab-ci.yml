image: docker:28.3.3

variables:
  SSH_PRIVATE_KEY: ${SSH_PRIVATE_KEY}
  DOCKER_REGISTRY: $CI_REGISTRY/$CI_PROJECT_PATH
  CONTAINER_LATEST_IMAGE: $DOCKER_REGISTRY:latest
  CONTAINER_COMMIT_IMAGE: $DOCKER_REGISTRY:$CI_COMMIT_SHORT_SHA
  LOCAL_BUILD_PATH: "src/"

stages:
  - build
  - deploy
  - deploy_s3

Build Image:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\// && $CI_COMMIT_MESSAGE =~ /\[NORUN\]/'
      when: manual
    - changes: # run automatically if any of these change
      - src/**/*
      - Dockerfile
      - Caddyfile
      - .gitlab-ci.yml
    - when: manual 
  services:
    - docker:28.3.3-dind
  before_script:
    - echo $CI_REGISTRY
    - echo $CI_PROJECT_PATH
    - echo $DOCKER_REGISTRY
    - echo $CONTAINER_COMMIT_IMAGE
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "BUILD_REF=$CI_COMMIT_REF_NAME" > src/buildinfo.txt
    - echo "BUILD_SHA=$CI_COMMIT_SHORT_SHA" >> src/buildinfo.txt
    - echo "BUILD_TAG=$CI_COMMIT_TAG" >> src/buildinfo.txt
    - docker build --network host -t $CONTAINER_LATEST_IMAGE -t $CONTAINER_COMMIT_IMAGE .
    - docker push $DOCKER_REGISTRY --all-tags
    #- docker system prune -af --filter "until=$((30*24))h"
  artifacts:
    paths:
    - src

Deploy Feature Instance:
  stage: deploy
  image: alpine:3.22
  environment: 
    name: feature
  tags:
    - homelab
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      changes: # run automatically if any of these change
        - .feature/*
      variables:
        PROXY_REDEPLOY: "true"
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\//'
      when: manual
    - when: never
  variables:
    SSH_PORT: "22"
    TARGET_HOST: $SSH_IP
    PROXY_REDEPLOY: "false"
  before_script:
    - |
      set -euo pipefail
      apk add --no-cache openssh-client bash file rsync
  script:
    - chmod 600 "$SSH_KEY"
    - ssh-keygen -lf "$SSH_KEY" || true
    - rsync -avz -e "ssh -i $SSH_KEY -o StrictHostKeyChecking=no" .feature/ "$SSH_USER@$TARGET_HOST:~/docker/feat-taylortrhodes-proxy/"
    - |
      ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$SSH_USER@$TARGET_HOST" "CI_REGISTRY=$CI_REGISTRY CI_REGISTRY_USER=$CI_REGISTRY_USER CI_REGISTRY_PASSWORD=$CI_REGISTRY_PASSWORD CONTAINER_COMMIT_IMAGE=$CONTAINER_COMMIT_IMAGE CI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA PROXY_REDEPLOY=$PROXY_REDEPLOY bash -s" <<'EOSSH'
      set -euo pipefail

      # --- Config ---
      proxy_path=~/docker/feat-taylortrhodes-proxy
      proxy_net=feat-taylortrhodes-proxy-net

      # --- Ensure network exists ---
      docker network inspect "$proxy_net" >/dev/null 2>&1 || docker network create --driver bridge "$proxy_net"

      # update proxy files and restart container
      mkdir -p "$proxy_path"
      if [ "$PROXY_REDEPLOY" == "true" ] || ! docker compose -f "$proxy_path/docker-compose.yml" ps feat-taylortrhodes-proxy 2>/dev/null | grep -q "Up"; then
        echo "Updating proxy files and restarting..."
        # Restart or start proxy
        docker compose -f "$proxy_path/docker-compose.yml" up -d --force-recreate
      fi

      # sanity checks
      echo checking variables
      : "${CI_REGISTRY:?missing}"
      : "${CI_REGISTRY_USER:?missing}"
      : "${CI_REGISTRY_PASSWORD:?missing}"
      : "${CONTAINER_COMMIT_IMAGE:?missing}"

      # login to GitLab Container Registry (NOT Docker Hub)
      echo logging in to gitlab docker registry
      echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin

      # pull first; only stop/replace on successful pull
      echo pull image from registry
      docker pull "$CONTAINER_COMMIT_IMAGE"

      if docker ps -a --format '{{.Names}}' | grep -q "^$CI_COMMIT_SHORT_SHA.feat.taylortrhodes.com$"; then
        echo removing existing container
        docker rm -f "$CI_COMMIT_SHORT_SHA.feat.taylortrhodes.com"
      fi

      echo starting new container
      docker run --rm --name $CI_COMMIT_SHORT_SHA.feat.taylortrhodes.com --network "$proxy_net" -d "$CONTAINER_COMMIT_IMAGE"
      EOSSH
    - echo feature is available at https://$CI_COMMIT_SHORT_SHA.feat.taylortrhodes.com
  timeout: 8 minutes

Deploy Dev Instance:
  stage: deploy
  image: alpine:3.22
  environment: 
    name: dev
    url: https://dev.taylortrhodes.com
  tags:
    - homelab
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
      allow_failure: true
    - when: never
  variables:
    SSH_PORT: "22"
    TARGET_HOST: $SSH_IP
  before_script:
    - |
      set -euo pipefail
      apk add --no-cache openssh-client bash file
  script:
    - chmod 600 "$SSH_KEY"
    - ssh-keygen -lf "$SSH_KEY" || true
    - |
      ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$SSH_USER@$TARGET_HOST" "CI_REGISTRY=$CI_REGISTRY CI_REGISTRY_USER=$CI_REGISTRY_USER CI_REGISTRY_PASSWORD=$CI_REGISTRY_PASSWORD CONTAINER_COMMIT_IMAGE=$CONTAINER_COMMIT_IMAGE bash -s" <<'EOSSH'
      set -euo pipefail

      # sanity checks
      echo checking varaibles
      : "${CI_REGISTRY:?missing}"
      : "${CI_REGISTRY_USER:?missing}"
      : "${CI_REGISTRY_PASSWORD:?missing}"
      : "${CONTAINER_COMMIT_IMAGE:?missing}"

      # login to GitLab Container Registry (NOT Docker Hub)
      echo logging in to gitlab docker registry
      echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
  
      # pull first; only stop/replace on successful pull
      echo pull image from registry
      docker pull "$CONTAINER_COMMIT_IMAGE"

      echo stopping and removing old container
      docker stop dev.taylortrhodes.com 2>/dev/null || true
      docker rm   dev.taylortrhodes.com 2>/dev/null || true

      echo starting new container
      docker run --name dev.taylortrhodes.com -p 8082:8080 --restart=always -d "$CONTAINER_COMMIT_IMAGE"
      EOSSH
  timeout: 5 minutes

Deploy DO VM:
  stage: deploy
  image: alpine:3.22
  environment:
    name: prod
    url: https://www.taylortrhodes.com
  tags:
    - homelab
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\//'
      when: manual
    - when: never
  variables:
    DO_API: "https://api.digitalocean.com/v2"
    SSH_PORT: "22"
    TARGET_HOST: $DO_VM_IP
    SSH_USER: "root"
  before_script:
    - |
      set -euo pipefail
      apk add --no-cache openssh-client bash
  #    apk add --no-cache openssh-client curl bash busybox-extras jq
  #    # discover this job's egress IP
  #    JOB_IP="$(curl -fsS https://checkip.amazonaws.com | tr -d '\n')"
  #    echo "Job egress IP: $JOB_IP"
  #    echo "$JOB_IP" > .allowlisted_ip
#
  #    # allow SSH from this job's /32
  #    ADD_PAYLOAD='{"inbound_rules":[{"protocol":"tcp","ports":"'"$SSH_PORT"'","sources":{"addresses":["'"$JOB_IP"'/32"]}}]}'
  #    ADD_CODE=$(curl -sS -o /tmp/do_add.json -w "%{http_code}" \
  #      -X POST "$DO_API/firewalls/$DO_FIREWALL_ID/rules" \
  #      -H "Authorization: Bearer $DO_TOKEN" \
  #      -H "Content-Type: application/json" \
  #      --data "$ADD_PAYLOAD")
  #    echo "DO add status: $ADD_CODE"
  #    if [ "$ADD_CODE" != "204" ] && [ "$ADD_CODE" != "200" ]; then
  #      cat /tmp/do_add.json
  #      exit 1
  #    fi
  script:
    - chmod 600 "$SSH_KEY"
    - ssh-keygen -lf "$SSH_KEY" || true
    - |
      ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$SSH_USER@$TARGET_HOST" "CI_REGISTRY=$CI_REGISTRY CI_REGISTRY_USER=$CI_REGISTRY_USER CI_REGISTRY_PASSWORD=$CI_REGISTRY_PASSWORD CONTAINER_COMMIT_IMAGE=$CONTAINER_COMMIT_IMAGE bash -s" <<'EOSSH'
      set -euo pipefail
  
      # sanity checks
      echo checking varaibles
      : "${CI_REGISTRY:?missing}"
      : "${CI_REGISTRY_USER:?missing}"
      : "${CI_REGISTRY_PASSWORD:?missing}"
      : "${CONTAINER_COMMIT_IMAGE:?missing}"
  
      # login to GitLab Container Registry (NOT Docker Hub)
      echo logging in to gitlab docker registry
      echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
  
      # pull first; only stop/replace on successful pull
      echo pull image from registry
      docker pull "$CONTAINER_COMMIT_IMAGE"
  
      echo stopping and removing old container
      docker stop taylortrhodes.com 2>/dev/null || true
      docker rm   taylortrhodes.com 2>/dev/null || true
  
      # NOTE: adjust right side of -p if your container listens on 80 vs 8080
      echo starting new container
      docker run --name taylortrhodes.com -p 8081:8080 --restart=always -d "$CONTAINER_COMMIT_IMAGE"
      EOSSH
  #after_script:
  #  - |
  #    # remove the allow rule (idempotent)
  #    echo cleaning up run environment
  #    if [ -f .allowlisted_ip ]; then
  #      JOB_IP="$(cat .allowlisted_ip)"
  #      DEL_PAYLOAD='{"inbound_rules":[{"protocol":"tcp","ports":"'"$SSH_PORT"'","sources":{"addresses":["'"$JOB_IP"'/32"]}}]}'
  #      DEL_CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
  #        -X DELETE "$DO_API/firewalls/$DO_FIREWALL_ID/rules" \
  #        -H "Authorization: Bearer $DO_TOKEN" \
  #        -H "Content-Type: application/json" \
  #        --data "$DEL_PAYLOAD")
  #      echo "DO delete status: $DEL_CODE"
  #    fi
  timeout: 5 minutes

#Deploy S3:
#  stage: deploy_s3
#  image:
#    name: amazon/aws-cli:2.17.19
#    entrypoint: [""]
#  needs: []
#  when: always
#  variables:
#    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
#    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
#    AWS_REGION: $AWS_REGION
#  script:
#    - |
#      set -euo pipefail
#
#      # Sync HTML with no-cache for instant updates
#      aws s3 sync src/ "s3://$S3_BUCKET/" \
#        --exclude "assets/*" --delete \
#        --cache-control "no-cache" --exact-timestamps --no-progress
#
#      # Sync versioned/static assets with long cache
#      aws s3 sync src/assets/ "s3://$S3_BUCKET/assets/" \
#        --delete \
#        --cache-control "public,max-age=31536000,immutable" \
#        --exact-timestamps --no-progress
